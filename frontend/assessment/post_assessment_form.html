{% extends 'dashboard/base.html' %}

{% block title %}Post-Assessment Form{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post-Assessment</title>
    <style>
    * {
        box-sizing: border-box;
        font-family: "Inter","Segoe UI",Arial,sans-serif;
    }

    /* Card */
    .assessment-container {
        max-width: 880px;
        margin: 40px auto;
        background: rgba(255,255,255,0.96);
        padding: 42px 46px;
        border-radius: 22px;
        box-shadow: 0 30px 60px rgba(0,0,0,.08);
        border: 1px solid rgba(200,200,200,.25);
    }

    /* Header */
    .header {
        text-align: center;
        padding-bottom: 26px;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 30px;
    }

    .header h1 {
        font-size: 30px;
        font-weight: 700;
        color: #4f46e5;
    }

    .header h2 {
        margin-top: 6px;
        font-size: 18px;
        color: #1e3a8a;
    }

    .header p {
        margin-top: 6px;
        font-size: 14px;
        color: #6b7280;
    }

    /* Training info */
    .training-info {
        background: #eef2ff;
        border-radius: 16px;
        padding: 18px 22px;
        margin-bottom: 26px;
        font-size: 16px;
        border: 1px solid #e0e7ff;
    }

    /* Progress */
    .progress-text {
        text-align: right;
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 6px;
    }

    .progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
    }

    .progress {
        height: 100%;
        background: linear-gradient(90deg,#6366f1,#4f46e5);
        transition: width .3s ease;
    }

    /* Question card */
    .question-card {
        background: white;
        border-radius: 20px;
        padding: 34px;
        border: 1px solid #e5e7eb;
        margin-top: 30px;
        position: relative;
    }

    .question-number {
        position: absolute;
        top: -16px;
        left: 26px;
        background: linear-gradient(135deg,#6366f1,#4f46e5);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .question-text {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 22px;
    }

    /* Options */
    .option {
        padding: 14px 18px;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        margin-bottom: 14px;
        cursor: pointer;
        transition: all .2s ease;
        display: flex;
        gap: 10px;
    }

    .option:hover {
        background: rgba(99,102,241,.08);
        border-color: #6366f1;
    }

    .option.selected {
        background: rgba(99,102,241,.14);
        border-color: #4f46e5;
    }

    .option input {
        margin-top: 4px;
    }

    /*Buttons */
    .submit-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 50px;
    }

    .nav-left,
    .nav-center,
    .nav-right {
        flex: 1;
        display: flex;
        align-items: center;
    }

    .nav-left {
        justify-content: flex-start;
    }

    .nav-center {
        justify-content: center;
    }

    .nav-right {
        justify-content: flex-end;
        gap: 14px;
    }

    .btn {
        padding: 12px 30px;
        border-radius: 999px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all .25s ease;
    }

    .btn-back {
        background: #f3f4f6;
        color: #374151;
    }

    .btn-back:hover {
        background: #e5e7eb;
    }

    .btn:not(.btn-back) {
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        box-shadow: 0 12px 28px rgba(79, 70, 229, .35);
    }


    .btn:disabled {
        opacity: .5;
        box-shadow: none;
        cursor: not-allowed;
    }

    .btn:not(.btn-back):hover:not(:disabled) {
        background: linear-gradient(135deg, #4f46e5, #4338ca);
        transform: translateY(-1px);
        box-shadow: 0 16px 36px rgba(79, 70, 229, .45);
    }


    .btn:not(.btn-back):active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 10px 22px rgba(79, 70, 229, .35);
    }

    .btn:not(.btn-back):focus-visible {
        outline: none;
        box-shadow:
            0 0 0 3px rgba(99, 102, 241, .35),
            0 12px 28px rgba(79, 70, 229, .35);
    }

    /* Warning */
    .warning-message {
        background: #fff7ed;
        color: #9a3412;
        padding: 20px;
        border-radius: 14px;
        border: 1px solid #fed7aa;
    }
    </style>

</head>
<body>
    {% if disabled %}
        <div class="assessment-container">
            <div class="warning-message">
                <h2>Assessment Not Available</h2>
                <p>{{ reason }}</p>
                <a href="{% url 'employee_dashboard' %}" class="btn btn-back">Back to Dashboard</a>
            </div>
        </div>
    {% else %}
        <div id="total-questions" style="display: none;">{{ questions|length }}</div>
        
        <form method="POST" class="assessment-container" id="assessmentForm">
            {% csrf_token %}
            
            <div class="header">
                <h1>Post-Assessment</h1>
                <h2>{{ training.title }}</h2>
                <p>Complete this assessment after the training to test your knowledge</p>
            </div>
            
            <div class="training-info">
                <p><strong>Training Date:</strong> {{ training.date }} at {{ training.time }}</p>
                <p><strong>Location:</strong> {{ training.location }}</p>
                <p><strong>Trainer:</strong> {{ training.trainer.username }}</p>
                <p><strong>CPD Points:</strong> {{ training.cpd_points }}</p>
            </div>
            
            <div class="progress-text" id="progress-text">Question 0 of {{ questions|length }}</div>
            <div class="progress-bar">
                <div class="progress" id="progress" style="width: 0%"></div>
            </div>
            
            {% for question in questions %}
                <div class="question-card" id="question-{{ forloop.counter }}" 
                     {% if not forloop.first %}style="display: none;"{% endif %}>
                    <div class="question-number">{{ forloop.counter }}</div>
                    <div class="question-text">{{ question.question_text }}</div>
                    
                    <div class="options-container">
                        <div class="option" onclick="selectOption(this, '{{ question.id }}', 'A')">
                            <input type="radio"
                                name="question_{{ question.id }}"
                                id="q{{ question.id }}_a"
                                value="A">
                            <label for="q{{ question.id }}_a">
                                <strong>A.</strong> {{ question.option_a }}
                            </label>
                        </div>

                        <div class="option" onclick="selectOption(this, '{{ question.id }}', 'B')">
                            <input type="radio"
                                name="question_{{ question.id }}"
                                id="q{{ question.id }}_b"
                                value="B">
                            <label for="q{{ question.id }}_b">
                                <strong>B.</strong> {{ question.option_b }}
                            </label>
                        </div>

                        <div class="option" onclick="selectOption(this, '{{ question.id }}', 'C')">
                            <input type="radio"
                                name="question_{{ question.id }}"
                                id="q{{ question.id }}_c"
                                value="C">
                            <label for="q{{ question.id }}_c">
                                <strong>C.</strong> {{ question.option_c }}
                            </label>
                        </div>

                        <div class="option" onclick="selectOption(this, '{{ question.id }}', 'D')">
                            <input type="radio"
                                name="question_{{ question.id }}"
                                id="q{{ question.id }}_d"
                                value="D">
                            <label for="q{{ question.id }}_d">
                                <strong>D.</strong> {{ question.option_d }}
                            </label>
                        </div>
                    </div>
                </div>
            {% endfor %}
            
            <div class="submit-section">
                <div class="nav-left">
                    <button type="button" class="btn btn-back" id="prev-btn" style="display: none;">
                        ← Previous
                    </button>
                </div>

                <div class="nav-center">
                    <button type="submit" class="btn" id="submit-btn" style="display: none;" disabled>
                        Submit Assessment
                    </button>
                </div>

                <div class="nav-right">
                    <button type="button" class="btn" id="next-btn">
                        Next →
                    </button>
                </div>
            </div>
        </form>
    {% endif %}
    
    <script>
        let currentQuestion = 1;
        let totalQuestions = parseInt(document.getElementById('total-questions').textContent);
        let questionsAnswered = new Set();
        
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        
        document.addEventListener('DOMContentLoaded', function() {
            if (prevBtn) prevBtn.onclick = prevQuestion;
            if (nextBtn) nextBtn.onclick = nextQuestion;
            
            updateNavigationButtons();
            updateProgress();
        });
        
        function updateProgress() {
            const progressPercent = (questionsAnswered.size / totalQuestions) * 100;
            document.getElementById('progress').style.width = `${progressPercent}%`;
            document.getElementById('progress-text').textContent = 
                `Question ${questionsAnswered.size} of ${totalQuestions}`;
        }
        
        function selectOption(element, questionId, value) {
            const options = element.parentElement.querySelectorAll('.option');
            options.forEach(opt => {
                opt.classList.remove('selected');
                opt.querySelector('input').checked = false;
            });
            
            element.classList.add('selected');
            element.querySelector('input').checked = true;
            
            questionsAnswered.add(questionId);
            
            updateProgress();
            
            checkAllAnswered();
        }
        
        function nextQuestion() {
            if (currentQuestion < totalQuestions) {
                document.getElementById(`question-${currentQuestion}`).style.display = 'none';
                
                currentQuestion++;
                document.getElementById(`question-${currentQuestion}`).style.display = 'block';
                
                updateNavigationButtons();
            } else if (currentQuestion === totalQuestions) {
                document.getElementById(`question-${currentQuestion}`).style.display = 'none';
                currentQuestion++;
                updateNavigationButtons();
            }
        }
        
        function prevQuestion() {
            if (currentQuestion > 1) {
                if (currentQuestion === totalQuestions + 1) {
                    document.getElementById(`question-${totalQuestions}`).style.display = 'block';
                } else {
                    document.getElementById(`question-${currentQuestion}`).style.display = 'none';
                    document.getElementById(`question-${currentQuestion - 1}`).style.display = 'block';
                }
                currentQuestion--;
                updateNavigationButtons();
            }
        }
        
        function updateNavigationButtons() {
            if (currentQuestion === 1) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-block';
            }
            
            if (currentQuestion <= totalQuestions) {
                nextBtn.style.display = 'inline-block';
                submitBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-block';
            }
        }
        
        function checkAllAnswered() {
            const allQuestionsAnswered = questionsAnswered.size === totalQuestions;
            
            if (allQuestionsAnswered) {
                submitBtn.disabled = false;
                submitBtn.title = '';
            } else {
                submitBtn.disabled = true;
                submitBtn.title = 'Please answer all questions';
            }
        }
    </script>
</body>
</html>

{% endblock %}