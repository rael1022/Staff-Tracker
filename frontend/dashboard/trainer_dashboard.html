<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>Trainer Dashboard</h2>
    <p>Welcome, {{ request.user.username }}!</p>
    
    <div id="trainer-trainings">
        <h2>My Trainings</h2>
        
        <div id="trainings-container">
            
        </div>
    </div>
</div>

<div id="attendance-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Attendance Management</h3>
            <button onclick="closeAttendanceModal()">×</button>
        </div>
        
        <div class="modal-body">
            <div id="attendance-stats"></div>
            
            <div class="section">
                <h4>Manual Check-in</h4>
                <div class="manual-checkin-form">
                    <input type="text" id="search-user" placeholder="Search user by username..." 
                           oninput="searchUsers(this.value)">
                    <div id="user-results" class="user-results"></div>
                    
                    <div id="selected-user" style="display:none;">
                        <p>Selected: <span id="selected-username"></span></p>
                        <button onclick="performManualCheckin()">✅ Check In User</button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h4>Attendance List</h4>
                <div id="attendance-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
function loadTrainerTrainings() {
    fetch('/attendance/api/trainer/trainings/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderTrainings(data.trainings);
            }
        });
}

function renderTrainings(trainings) {
    const container = document.getElementById('trainings-container');
    container.innerHTML = '';
    
    trainings.forEach(training => {
        const trainingDiv = document.createElement('div');
        trainingDiv.className = 'training-card';
        trainingDiv.innerHTML = `
            <div class="training-header">
                <h3>${training.title}</h3>
                <span class="training-status ${training.status}">${training.status}</span>
            </div>
            <p>${training.description}</p>
            <div class="training-details">
                <span>${training.date} ${training.time}</span>
                <span>${training.location}</span>
                <span>${training.cpd_points} CPD Points</span>
            </div>
            <div class="training-actions">
                <button onclick="generateQR(${training.id}, '${training.title.replace(/'/g, "\\'")}')">
                    Generate QR Code
                </button>
                <button onclick="viewAttendance(${training.id})">
                    View Attendance
                </button>
            </div>
            <div id="qr-result-${training.id}" class="qr-result"></div>
        `;
        container.appendChild(trainingDiv);
    });
}

function generateQR(trainingId, trainingTitle) {
    fetch('/attendance/api/trainer/generate-qr/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            training_id: trainingId,
            training_title: trainingTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const qrContainer = document.getElementById(`qr-result-${trainingId}`);
            qrContainer.innerHTML = `
                <div class="qr-display">
                    <h4>Check-in QR Code</h4>
                    <img src="${data.qr_image}" alt="QR Code" style="width: 150px; height: 150px;">
                    <p><small>Valid until: ${data.expires_human}</small></p>
                    <button onclick="downloadQR('${data.qr_image}', '${trainingTitle}')">
                        Download QR
                    </button>
                    <button onclick="printQR('${data.qr_image}')">
                        Print QR
                    </button>
                </div>
            `;
            
            alert(`QR code generated for ${trainingTitle}`);
        } else {
            alert('Error: ' + data.message);
        }
    });
}

let currentTrainingId = null;
let selectedUserId = null;

function viewAttendance(trainingId) {
    openAttendanceModal(trainingId);
}

function openAttendanceModal(trainingId) {
    currentTrainingId = trainingId;
    document.getElementById('attendance-modal').style.display = 'block';
    loadAttendanceData(trainingId);
}

function closeAttendanceModal() {
    document.getElementById('attendance-modal').style.display = 'none';
    currentTrainingId = null;
    selectedUserId = null;
}

function loadAttendanceData(trainingId) {
    fetch(`/attendance/api/trainer/attendance/${trainingId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderAttendanceData(data);
            }
        });
}

function renderAttendanceData(data) {
    document.getElementById('modal-title').textContent = 
        data.training_info ? `Attendance - ${data.training_info.title}` : 'Attendance';
    
    const statsDiv = document.getElementById('attendance-stats');
    statsDiv.innerHTML = `
        <div class="stats">
            <div class="stat">
                <span class="stat-number">${data.total}</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat">
                <span class="stat-number" style="color: green;">${data.present}</span>
                <span class="stat-label">Present</span>
            </div>
            <div class="stat">
                <span class="stat-number" style="color: red;">${data.absent}</span>
                <span class="stat-label">Absent</span>
            </div>
        </div>
    `;
    
    const listDiv = document.getElementById('attendance-list');
    if (data.attendances.length === 0) {
        listDiv.innerHTML = '<p>No attendance records yet.</p>';
        return;
    }
    
    let html = '<table class="table table-striped"><thead><tr>';
    html += '<th>User</th><th>Status</th><th>Check-in Time</th><th>Method</th></tr></thead><tbody>';
    
    data.attendances.forEach(att => {
        const user = att.user || {username: 'N/A', full_name: 'Unknown'};
        const status = att.status === 'Present' ? '✅ Present' : '❌ Absent';
        const time = att.check_in_time ? new Date(att.check_in_time).toLocaleString() : '-';
        const method = att.is_qr_checkin ? 'QR Code' : 'Manual';
        
        html += `<tr>
            <td>${user.full_name} (${user.username})</td>
            <td>${status}</td>
            <td>${time}</td>
            <td>${method}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    listDiv.innerHTML = html;
}

function searchUsers(query) {
    if (!query || query.length < 2) {
        document.getElementById('user-results').innerHTML = '';
        return;
    }
    
    document.getElementById('user-results').innerHTML = `
        <div class="alert alert-info">
            <p>For testing manual check-in:</p>
            <div class="input-group">
                <input type="text" id="manual-username" class="form-control" placeholder="Enter username">
                <button class="btn btn-primary" onclick="useManualUser()">Select</button>
            </div>
            <small class="text-muted">Note: User must be registered and approved for this training.</small>
        </div>
    `;
}

function useManualUser() {
    const username = document.getElementById('manual-username').value;
    if (username) {
        document.getElementById('selected-username').textContent = username;
        document.getElementById('selected-user').style.display = 'block';
        document.getElementById('user-results').innerHTML = '';
    }
}

function performManualCheckin() {
    if (!currentTrainingId || !selectedUserId) return;
    
    fetch('/attendance/api/trainer/manual-checkin/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            training_id: currentTrainingId,
            username: selectedUserId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Manual check-in successful!');
            loadAttendanceData(currentTrainingId);
            selectedUserId = null;
            document.getElementById('selected-user').style.display = 'none';
            document.getElementById('search-user').value = '';
        } else {
            alert('Error: ' + data.message);
        }
    });
}

function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === ('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    
    if (!cookieValue) {
        const metaToken = document.querySelector('meta[name="csrf-token"]');
        if (metaToken) {
            cookieValue = metaToken.getAttribute('content');
        }
    }
    
    if (!cookieValue) {
        const inputToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (inputToken) {
            cookieValue = inputToken.value;
        }
    }
    
    return cookieValue || '';
}

function downloadQR(qrImage, title) {
    const link = document.createElement('a');
    link.href = qrImage;
    link.download = `qr-${title.replace(/[^a-z0-9]/gi, '-')}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

document.addEventListener('DOMContentLoaded', function() {
    loadTrainerTrainings();
    
    document.getElementById('attendance-modal').addEventListener('click', function(e) {
        if (e.target.id === 'attendance-modal') {
            closeAttendanceModal();
        }
    });
});
</script>
{% endblock %}
</body>
</html>