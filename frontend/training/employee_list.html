{% extends 'dashboard/base.html' %}
{% load evaluation_tags %}

{% block content %}

<style>
h2 {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
}

.filter-card {
    background: #f9fafc;
    padding: 20px 25px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    max-width: 900px;
    margin: 0 auto 20px auto;
}

.filter-card h3 {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 15px;
    color: #333;
}

.filter-form {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
    align-items: flex-end;
}

.filter-group {
    flex: 1 1 200px;
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 5px;
    color: #555;
}

.filter-group input[type="date"] {
    padding: 7px 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
    width: 100%;
    box-sizing: border-box;
}

.filter-actions {
    display: flex;
    gap: 10px;
    flex: 1 1 100%;
    justify-content: center;
    margin-top: 10px;
}

.btn {
    padding: 8px 16px;
    font-size: 14px;
    border-radius: 6px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    display: inline-block;
}h2 {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
}

.filter-card {
    background: #fff;
    padding: 20px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    max-width: 900px;
    margin: 0 auto 20px auto;
    transition: all 0.2s ease;
}

.filter-card h3 {
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 15px;
    color: #333;
}

.filter-form {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
    align-items: flex-end;
}

.filter-group {
    flex: 1 1 200px;
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-size: 13px;
    font-weight: 500;
    margin-bottom: 6px;
    color: #555;
}

.filter-group select,
.filter-group input[type="date"] {
    padding: 8px 12px;
    font-size: 14px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: #f9fafb;
    transition: all 0.2s ease;
}

.filter-group select:focus,
.filter-group input[type="date"]:focus {
    outline: none;
    border-color: #6366f1;
    background: #fff;
    box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
}

.filter-actions {
    display: flex;
    gap: 10px;
    flex: 1 1 100%;
    justify-content: center;
    margin-top: 10px;
}

.filter-actions .btn {
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
}

.filter-actions .btn-primary {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: #fff;
}

.filter-actions .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(79,70,229,0.35);
}

.filter-actions .btn-secondary {
    background: #6c757d;
    color: #fff;
}

.filter-actions .btn-secondary:hover {
    background: #565e64;
}

.card {
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

th, td {
    border: 1px solid #ddd;
    padding: 10px;
    font-size: 14px;
    text-align: left;
}

th {
    background-color: #f2f4f7;
    font-weight: 600;
}

.status {
    font-weight: 500;
}

.status-pending {
    color: #ff9800;
}

.status-approved {
    color: green;
}

.status-rejected {
    color: red;
}

.btn-register {
    display: inline-block;
    padding: 6px 14px;
    font-size: 13px;
    font-weight: 500;
    color: #fff;
    background-color: #007bff;
    border-radius: 4px;
    text-decoration: none;
}

.btn-register:hover {
    background-color: #0056b3;
}

.assessment-status {
    font-weight: 500;
}

.assessment-completed {
    color: green;
    cursor: default;
}

.assessment-no-questions {
    color: #ff9800;
}

.assessment-available {
    color: #007bff;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fff;
    margin: 15% auto;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
    text-align: center;
}

.modal-close {
    margin-top: 15px;
    padding: 8px 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

@media (max-width: 700px) {
    .filter-form {
        flex-direction: column;
    }
    .filter-actions {
        justify-content: center;
    }
}

</style>

<h2>Available Trainings</h2>

<div class="filter-card">
    <h3>Filter Trainings</h3>
    <form method="get" class="filter-form">
        <div class="filter-group">
            <label for="trainer">Trainer</label>
            <select name="trainer" id="trainer">
                <option value="">-- All Trainers --</option>
                {% for t in trainers %}
                    <option value="{{ t.id }}" {% if selected_trainer and selected_trainer|add:"" == t.id|add:"" %}selected{% endif %}>
                        {{ t.get_full_name|default:t.username }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="start_date">Start Date</label>
            <input type="date" name="start_date" id="start_date" value="{{ start_date }}">
        </div>

        <div class="filter-group">
            <label for="end_date">End Date</label>
            <input type="date" name="end_date" id="end_date" value="{{ end_date }}">
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="{% url 'employee_dashboard' %}" class="btn btn-secondary">Reset</a>
        </div>
    </form>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>Title</th>
                <th>Date</th>
                <th>Time</th>
                <th>Trainer</th>
                <th>Duration (hours)</th>
                <th>Location</th>
                <th>CPD Points</th>
                <th>Status</th>
                <th>Assessment</th>
                <th>Evaluation</th>
            </tr>
        </thead>
        <tbody>
            {% load training_tags %}
            {% for training in trainings %}
            <tr>
                <td>{{ training.title }}</td>
                <td>{{ training.date }}</td>
                <td>{{ training.time }}</td>
                <td>{{ training.trainer }}</td>
                <td>{{ training.duration_hours }}</td>
                <td>{{ training.location }}</td>
                <td>{{ training.cpd_points }}</td>
                <td>
                    {% with reg=registrations|get_training_registration:training.id %}
                        {% if reg %}
                            <span class="status
                                {% if reg.status == 'Pending' %}status-pending
                                {% elif reg.status == 'Approved' %}status-approved
                                {% elif reg.status == 'Rejected' %}status-rejected
                                {% endif %}
                            ">
                                {{ reg.status }}
                            </span>
                        {% else %}
                        <a href="{% url 'register_training' training.id %}" class="btn-register">
                            Register
                        </a>
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    {% with reg=registrations|get_training_registration:training.id %}
                        {% if reg and reg.status == 'Approved' %}
                            {% load assessment_tags %}
                            
                            {% if training.id|has_pre_assessment_questions %}
                                {% if training.id|has_completed_pre_assessment:request.user %}
                                    <span class="assessment-status assessment-completed">Pre ✓</span>
                                {% elif reg.complete_status != 'Completed' %}
                                    <a href="{% url 'pre_assessment' training_id=training.id %}" 
                                    class="assessment-available">Pre-Assessment</a>
                                {% else %}
                                    <span class="text-muted">Pre (Not Available)</span>
                                {% endif %}
                            {% else %}
                                <span class="assessment-status assessment-no-questions">No Pre</span>
                            {% endif %}
                            
                            <br>
                            
                            {% if reg.complete_status == 'Completed' %}
                                {% if training.id|has_post_assessment_questions %}
                                    {% if training.id|has_completed_post_assessment:request.user %}
                                        <span class="assessment-status assessment-completed">Post ✓</span>
                                    {% else %}
                                        {% if training.id|has_completed_pre_assessment:request.user %}
                                            <a href="{% url 'post_assessment' training_id=training.id %}" 
                                            class="assessment-available">Post-Assessment</a>
                                        {% else %}
                                            <span class="text-muted">Complete Pre First</span>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    <span class="assessment-status assessment-no-questions">No Post</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Post (Training Not Completed)</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not Eligible</span>
                        {% endif %}
                    {% endwith %}
                </td>
                <td>
                    {% with reg=registrations|get_training_registration:training.id %}
                        {% if reg and reg.status == 'Approved' %}
                            {% if reg.complete_status == 'Completed' %}
                                {% if training|has_evaluated:request.user %}
                                    <span class="text-success">✓ Evaluated</span>
                                {% else %}
                                    <a href="{% url 'submit_evaluation' training.id %}" class="btn btn-primary btn-sm">
                                        Evaluate
                                    </a>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Training Not Completed</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not Eligible</span>
                        {% endif %}
                    {% endwith %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">No trainings available.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function showCompletedMessage() {
    document.getElementById('completedModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('completedModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    const completedAssessments = document.querySelectorAll('.assessment-completed');
    completedAssessments.forEach(element => {
        element.style.cursor = 'default';
        element.onclick = function(e) {
            e.preventDefault();
            showCompletedMessage();
        };
    });
});
</script>

<div id="completedModal" class="modal">
    <div class="modal-content">
        <h3>Assessment Already Completed</h3>
        <p>You have already completed this assessment.</p>
        <button class="modal-close" onclick="closeModal()">OK</button>
    </div>
</div>

{% endblock %}
